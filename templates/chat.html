<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
	<link rel="stylesheet" type="text/css" href="{% static 'css/vayu.css' %}">
	<style type="text/css">
		html, body{
			height: 100%;
		}

		.scroll::-webkit-scrollbar {
 	 		width: 4px;
			background: rgba(0, 0, 0, .0);
		}
		
		.scroll::-webkit-scrollbar-thumb {
  			background-color: rgba(0, 0, 0, .6);
		}
	</style>
</head>
<body>
	<div class="menu">
        <button class="wave sharp transparent button" style="padding:0px;width: 10%;font-size: 4.5vh;height: 100%;padding-top: 1vh;padding-bottom: 1vh; color: white;" >ðŸ¡¨</button>
        <div class="name">{{ recipient.username }}</div>
        <div class="last">{% if recipient.chatprofile.online %}online{% else %}offline{% endif %}</div>
    </div>
    <ol class="chat scroll">
    </ol>
    <form id="message-form" action="{% url 'send_message' %}" enctype="multipart/form-data">
    	<div style="display: none;">
    		{{ form.as_p }}
    	</div>
	    <div class="chat-input-div">
	    	<textarea class="chat-input scroll" id="chat-input" rows=1 name="message" type="text" placeholder="Type a message...."></textarea>
	    	<input id="file-input" style="display: none;" type="file" name="attachments" multiple>
	    	<input id="image-input" style="display: none;" type="file" name="images" multiple>
	    	<button style="padding:0px;" type="submit" class="send button blue filled wave sharp">send</button> 
		</div>
	    <div class="chat-input-div">
	    	<button type="button" id="emoji" class="tri-button button transparent wave sharp" style="padding:0px;float: left;">emoji</button> 
	    	<button type="button" id="image-input-button" class="tri-button button transparent wave sharp" style="padding:0px;margin:0px;">image<p style="display: none;" class="img-count"></p></button> 
	    	<button type="button" id="file-input-button" class="tri-button button transparent wave sharp" style="padding:0px;float: right;">attachment<p style="display: none;" class="file-count"></p></button> 
	    </div>
    </form>
</body>




<script type="text/javascript" src="{% static 'js/jquery.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/vayu.js' %}"></script>
<script type="text/javascript">

	function getCookie(name) {
	    var cookieValue = null;
	    if (document.cookie && document.cookie != '') {
	        var cookies = document.cookie.split(';');
	        for (var i = 0; i < cookies.length; i++) {
	            var cookie = jQuery.trim(cookies[i]);
	            // Does this cookie string begin with the name we want?
	            if (cookie.substring(0, name.length + 1) == (name + '=')) {
	                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                break;
	            }
	        }
	    }
	    return cookieValue;
	}

	$.ajaxSetup({
	    beforeSend: function(xhr, settings) {
	        if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
	            // Only send the token to relative URLs i.e. locally.
	            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
	        }
	    }
	});


	var filebtn = $('#file-input-button'), imagebtn = $('#image-input-button');
	var file = $('#file-input'), image = $('#image-input');
	socket = new WebSocket("ws://"+window.location.host+"/chat/")
	socket.onmessage = function(event){
		var chatdiv = $('.chat');
		var data = JSON.parse(event.data);
		// console.log(data);
		chatdiv.append(data.html);
		// chatdiv.append("<li class='self'><div class='msg'><p>"+data.message+"</p><time>"+Date.now()+"</time></div></li>");
	}
	$('#message-form').submit(function(event){
		event.preventDefault();
		var form = new FormData(this);
		var url = $(this).attr('action');
		var text = $('#chat-input').val();
		// console.log($("input[name='csrfmiddlewaretoken']").attr('value'));
		if($.trim(text).length != 0 || file.val()!="" || image.val()!="" ){
			$.ajax({
				type: "POST",
				url: url,
				data: form,
		        success: function (data) {
					$('#chat-input').val("");
					$('#file-input').val("");
					$('#image-input').val("");
					$(".img-count").html("");
					$(".img-count").hide();
					$(".file-count").html("");
					$(".file-count").hide();
		        },
		        error: function (data) {
		            alert("error"+data)
		        },
		        cache: false,
		        contentType: false,
		        processData: false,
			});
			// $.post(url, form, function(data){alert(data);});
		}
	});

	filebtn.click(function(e){
		file.trigger("click");
	});

	imagebtn.click(function(e){
		image.trigger("click");
	});

	$('.chat-input').keyup(function (event) {
    	if (event.keyCode == 13 & !event.shiftKey) {          
            $('#message-form').submit();
    	}
	});

	var ValidImageTypes = ["image/gif", "image/jpeg", "image/png"];

	image.change(function(e){
		var boolsize = true, booltype = true;
		for(i=0; i < e.target.files.length; i++){
			var fl = e.target.files[i];
			if ((fl.size/(1024*1024)) > 10)
				boolsize = false;

			if($.inArray(fl["type"], ValidImageTypes) < 0)
				booltype = false
		}
		if(!boolsize)
		{
			image.val("");
			alert("Upload image size should be below 10 Mb");
		}
		else if(!booltype)
		{
			image.val("");
			alert("Uploaded image should be among "+ValidImageTypes);
		}
		$(".img-count").show();
		$(".img-count").html(e.target.files.length);
	});

	file.change(function(e){
		var boolsize = true;
		for(i=0; i < e.target.files.length; i++){
			var fl = e.target.files[i];
			if ((fl.size/(1024*1024)) > 25)
				boolsize = false;
		}
		if(!boolsize)
		{
			file.val("");
			alert("Upload file size should be below 25 Mb");
		}
		$(".file-count").show();
		$(".file-count").html(e.target.files.length);
	});


</script>